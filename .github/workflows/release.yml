name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    env:
      APP_NAME: ChimeDock
      SCHEME: ChimeDock
      KEYCHAIN: build.keychain-db
      KEYCHAIN_PASSWORD: temporary-ci-password

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Run tests
        run: |
          xcodebuild test \
            -scheme $SCHEME \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO

      - name: Import signing certificate
        env:
          P12_BASE64: ${{ secrets.DEVELOPER_ID_CERTIFICATE_P12 }}
          P12_PASSWORD: ${{ secrets.DEVELOPER_ID_CERTIFICATE_PASSWORD }}
        run: |
          CERT_PATH="$RUNNER_TEMP/certificate.p12"
          echo "$P12_BASE64" | base64 --decode > "$CERT_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security set-keychain-settings -lut 21600 "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"

          security import "$CERT_PATH" \
            -k "$KEYCHAIN" \
            -P "$P12_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security list-keychains -d user -s "$KEYCHAIN" login.keychain-db

      - name: Archive
        run: |
          xcodebuild archive \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath "$RUNNER_TEMP/$APP_NAME.xcarchive" \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="3M2F6CPXXK" \
            -quiet

      - name: Export with Developer ID signing
        run: |
          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/$APP_NAME.xcarchive" \
            -exportPath "$RUNNER_TEMP/export" \
            -exportOptionsPlist ExportOptions.plist \
            -quiet

      - name: Verify code signature
        run: codesign --verify --deep --strict "$RUNNER_TEMP/export/$APP_NAME.app"

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          create-dmg \
            --volname "$APP_NAME" \
            --window-pos 200 120 \
            --window-size 480 320 \
            --icon-size 80 \
            --icon "$APP_NAME.app" 120 160 \
            --app-drop-link 360 160 \
            --no-internet-enable \
            "$RUNNER_TEMP/$APP_NAME.dmg" \
            "$RUNNER_TEMP/export/$APP_NAME.app"

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
        run: |
          xcrun notarytool submit "$RUNNER_TEMP/$APP_NAME.dmg" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APP_PASSWORD" \
            --wait

      - name: Staple notarization ticket
        run: xcrun stapler staple "$RUNNER_TEMP/$APP_NAME.dmg"

      - name: Compute DMG SHA256
        id: sha256
        run: echo "sha256=$(shasum -a 256 "$RUNNER_TEMP/$APP_NAME.dmg" | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Upload DMG to release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ runner.temp }}/ChimeDock.dmg
          generate_release_notes: true

      - name: Update Homebrew cask
        env:
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          VERSION: ${{ github.ref_name }}
          SHA256: ${{ steps.sha256.outputs.sha256 }}
        run: |
          VERSION="${VERSION#v}"
          git clone https://x-access-token:${TAP_TOKEN}@github.com/ragnarok22/homebrew-chimedock.git "$RUNNER_TEMP/tap"
          cd "$RUNNER_TEMP/tap"
          sed -i '' "s/version \".*\"/version \"${VERSION}\"/" Casks/chimedock.rb
          sed -i '' "s/sha256 \".*\"/sha256 \"${SHA256}\"/" Casks/chimedock.rb
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/chimedock.rb
          git commit -m "Update ChimeDock to ${VERSION}"
          git push

      - name: Cleanup keychain
        if: always()
        run: security delete-keychain "$KEYCHAIN" 2>/dev/null || true
