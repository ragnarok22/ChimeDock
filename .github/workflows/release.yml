name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    env:
      APP_NAME: ChimeDock
      SCHEME: ChimeDock
      KEYCHAIN: build.keychain-db
      KEYCHAIN_PASSWORD: temporary-ci-password

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Run tests
        run: |
          xcodebuild test \
            -scheme $SCHEME \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO

      - name: Import signing certificate
        env:
          P12_BASE64: ${{ secrets.DEVELOPER_ID_CERTIFICATE_P12 }}
          P12_PASSWORD: ${{ secrets.DEVELOPER_ID_CERTIFICATE_PASSWORD }}
        run: |
          CERT_PATH="$RUNNER_TEMP/certificate.p12"
          echo "$P12_BASE64" | base64 --decode > "$CERT_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security set-keychain-settings -lut 21600 "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"

          security import "$CERT_PATH" \
            -k "$KEYCHAIN" \
            -P "$P12_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security list-keychains -d user -s "$KEYCHAIN" login.keychain-db

      - name: Archive
        run: |
          xcodebuild archive \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath "$RUNNER_TEMP/$APP_NAME.xcarchive" \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="3M2F6CPXXK" \
            -quiet

      - name: Export with Developer ID signing
        run: |
          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/$APP_NAME.xcarchive" \
            -exportPath "$RUNNER_TEMP/export" \
            -exportOptionsPlist ExportOptions.plist \
            -quiet

      - name: Verify code signature
        run: codesign --verify --deep --strict "$RUNNER_TEMP/export/$APP_NAME.app"

      - name: Create DMG
        run: |
          DMG_STAGING="$RUNNER_TEMP/dmg-staging"
          mkdir -p "$DMG_STAGING"
          cp -R "$RUNNER_TEMP/export/$APP_NAME.app" "$DMG_STAGING/"
          ln -s /Applications "$DMG_STAGING/Applications"

          hdiutil create \
            -volname "$APP_NAME" \
            -srcfolder "$DMG_STAGING" \
            -ov \
            -format UDRW \
            "$RUNNER_TEMP/$APP_NAME-rw.dmg"

          MOUNT_DIR="/Volumes/$APP_NAME"
          hdiutil attach "$RUNNER_TEMP/$APP_NAME-rw.dmg" -mountpoint "$MOUNT_DIR"
          osascript <<'APPLESCRIPT'
          tell application "Finder"
            tell disk "ChimeDock"
              open
              set current view of container window to icon view
              set toolbar visible of container window to false
              set statusbar visible of container window to false
              set bounds of container window to {400, 200, 880, 520}
              set theViewOptions to icon view options of container window
              set arrangement of theViewOptions to not arranged
              set icon size of theViewOptions to 80
              set position of item "ChimeDock.app" of container window to {120, 160}
              set position of item "Applications" of container window to {360, 160}
              delay 2
              update without registering applications
              close
            end tell
          end tell
          APPLESCRIPT
          sync
          sleep 2
          hdiutil detach "$MOUNT_DIR"

          hdiutil convert \
            "$RUNNER_TEMP/$APP_NAME-rw.dmg" \
            -format UDZO \
            -o "$RUNNER_TEMP/$APP_NAME.dmg"
          rm -f "$RUNNER_TEMP/$APP_NAME-rw.dmg"

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
        run: |
          xcrun notarytool submit "$RUNNER_TEMP/$APP_NAME.dmg" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APP_PASSWORD" \
            --wait

      - name: Staple notarization ticket
        run: xcrun stapler staple "$RUNNER_TEMP/$APP_NAME.dmg"

      - name: Upload DMG to release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ runner.temp }}/ChimeDock.dmg
          generate_release_notes: true

      - name: Cleanup keychain
        if: always()
        run: security delete-keychain "$KEYCHAIN" 2>/dev/null || true
